"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "getStaticHandler", {
    enumerable: true,
    get: function() {
        return getStaticHandler;
    }
});
const _createKey = require("./utilities/createKey");
const _getStorageClient = require("./utilities/getStorageClient");
const getStaticHandler = ({ cachingOptions, collection })=>{
    let maxAge = 86400 // 24 hours default
    ;
    let collCacheConfig;
    if (cachingOptions !== false) {
        // Set custom maxAge for all collections
        maxAge = cachingOptions?.maxAge || maxAge;
        collCacheConfig = cachingOptions?.collections?.[collection.slug] || {};
    }
    // Set maxAge using collection-specific override
    maxAge = collCacheConfig?.maxAge || maxAge;
    const cachingEnabled = cachingOptions !== false && !!process.env.PAYLOAD_CLOUD_CACHE_KEY && collCacheConfig?.enabled !== false;
    return async (req, res, next)=>{
        const filename = req.params.filename;
        let fileKeyWithPrefix = '';
        if (!filename) {
            req.payload.logger.warn({
                msg: `No filename provided for static file against collection: ${collection.slug}`
            });
        }
        try {
            const { identityID, storageClient } = await (0, _getStorageClient.getStorageClient)();
            fileKeyWithPrefix = (0, _createKey.createKey)({
                collection: collection.slug,
                filename,
                identityID
            });
            const object = await storageClient.getObject({
                Bucket: process.env.PAYLOAD_CLOUD_BUCKET,
                Key: fileKeyWithPrefix
            });
            res.set({
                'Content-Length': object.ContentLength,
                'Content-Type': object.ContentType,
                ...cachingEnabled && {
                    'Cache-Control': `public, max-age=${maxAge}`
                },
                ETag: object.ETag
            });
            if (object?.Body) {
                return object.Body.pipe(res);
            }
            return next();
        } catch (err) {
            req.payload.logger.error({
                err,
                msg: `Error getting file from cloud storage: '${fileKeyWithPrefix}'`
            });
            return next();
        }
    };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGF0aWNIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29sbGVjdGlvbkNvbmZpZyB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5pbXBvcnQgdHlwZSB7IFJlYWRhYmxlIH0gZnJvbSAnc3RyZWFtJ1xuXG5pbXBvcnQgdHlwZSB7IENvbGxlY3Rpb25DYWNoaW5nQ29uZmlnLCBQbHVnaW5PcHRpb25zLCBTdGF0aWNIYW5kbGVyIH0gZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgY3JlYXRlS2V5IH0gZnJvbSAnLi91dGlsaXRpZXMvY3JlYXRlS2V5J1xuaW1wb3J0IHsgZ2V0U3RvcmFnZUNsaWVudCB9IGZyb20gJy4vdXRpbGl0aWVzL2dldFN0b3JhZ2VDbGllbnQnXG5cbmludGVyZmFjZSBBcmdzIHtcbiAgY2FjaGluZ09wdGlvbnM/OiBQbHVnaW5PcHRpb25zWyd1cGxvYWRDYWNoaW5nJ11cbiAgY29sbGVjdGlvbjogQ29sbGVjdGlvbkNvbmZpZ1xufVxuXG5leHBvcnQgY29uc3QgZ2V0U3RhdGljSGFuZGxlciA9ICh7IGNhY2hpbmdPcHRpb25zLCBjb2xsZWN0aW9uIH06IEFyZ3MpOiBTdGF0aWNIYW5kbGVyID0+IHtcbiAgbGV0IG1heEFnZSA9IDg2NDAwIC8vIDI0IGhvdXJzIGRlZmF1bHRcbiAgbGV0IGNvbGxDYWNoZUNvbmZpZzogQ29sbGVjdGlvbkNhY2hpbmdDb25maWcgfCB1bmRlZmluZWRcbiAgaWYgKGNhY2hpbmdPcHRpb25zICE9PSBmYWxzZSkge1xuICAgIC8vIFNldCBjdXN0b20gbWF4QWdlIGZvciBhbGwgY29sbGVjdGlvbnNcbiAgICBtYXhBZ2UgPSBjYWNoaW5nT3B0aW9ucz8ubWF4QWdlIHx8IG1heEFnZVxuICAgIGNvbGxDYWNoZUNvbmZpZyA9IGNhY2hpbmdPcHRpb25zPy5jb2xsZWN0aW9ucz8uW2NvbGxlY3Rpb24uc2x1Z10gfHwge31cbiAgfVxuXG4gIC8vIFNldCBtYXhBZ2UgdXNpbmcgY29sbGVjdGlvbi1zcGVjaWZpYyBvdmVycmlkZVxuICBtYXhBZ2UgPSBjb2xsQ2FjaGVDb25maWc/Lm1heEFnZSB8fCBtYXhBZ2VcblxuICBjb25zdCBjYWNoaW5nRW5hYmxlZCA9XG4gICAgY2FjaGluZ09wdGlvbnMgIT09IGZhbHNlICYmXG4gICAgISFwcm9jZXNzLmVudi5QQVlMT0FEX0NMT1VEX0NBQ0hFX0tFWSAmJlxuICAgIGNvbGxDYWNoZUNvbmZpZz8uZW5hYmxlZCAhPT0gZmFsc2VcblxuICByZXR1cm4gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc3QgZmlsZW5hbWUgPSByZXEucGFyYW1zLmZpbGVuYW1lXG4gICAgbGV0IGZpbGVLZXlXaXRoUHJlZml4ID0gJydcblxuICAgIGlmICghZmlsZW5hbWUpIHtcbiAgICAgIHJlcS5wYXlsb2FkLmxvZ2dlci53YXJuKHtcbiAgICAgICAgbXNnOiBgTm8gZmlsZW5hbWUgcHJvdmlkZWQgZm9yIHN0YXRpYyBmaWxlIGFnYWluc3QgY29sbGVjdGlvbjogJHtjb2xsZWN0aW9uLnNsdWd9YCxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWRlbnRpdHlJRCwgc3RvcmFnZUNsaWVudCB9ID0gYXdhaXQgZ2V0U3RvcmFnZUNsaWVudCgpXG5cbiAgICAgIGZpbGVLZXlXaXRoUHJlZml4ID0gY3JlYXRlS2V5KHtcbiAgICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbi5zbHVnLFxuICAgICAgICBmaWxlbmFtZSxcbiAgICAgICAgaWRlbnRpdHlJRCxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IHN0b3JhZ2VDbGllbnQuZ2V0T2JqZWN0KHtcbiAgICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5QQVlMT0FEX0NMT1VEX0JVQ0tFVCxcbiAgICAgICAgS2V5OiBmaWxlS2V5V2l0aFByZWZpeCxcbiAgICAgIH0pXG5cbiAgICAgIHJlcy5zZXQoe1xuICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBvYmplY3QuQ29udGVudExlbmd0aCxcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IG9iamVjdC5Db250ZW50VHlwZSxcbiAgICAgICAgLi4uKGNhY2hpbmdFbmFibGVkICYmIHsgJ0NhY2hlLUNvbnRyb2wnOiBgcHVibGljLCBtYXgtYWdlPSR7bWF4QWdlfWAgfSksXG4gICAgICAgIEVUYWc6IG9iamVjdC5FVGFnLFxuICAgICAgfSlcblxuICAgICAgaWYgKG9iamVjdD8uQm9keSkge1xuICAgICAgICByZXR1cm4gKG9iamVjdC5Cb2R5IGFzIFJlYWRhYmxlKS5waXBlKHJlcylcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG5leHQoKVxuICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgcmVxLnBheWxvYWQubG9nZ2VyLmVycm9yKHtcbiAgICAgICAgZXJyLFxuICAgICAgICBtc2c6IGBFcnJvciBnZXR0aW5nIGZpbGUgZnJvbSBjbG91ZCBzdG9yYWdlOiAnJHtmaWxlS2V5V2l0aFByZWZpeH0nYCxcbiAgICAgIH0pXG4gICAgICByZXR1cm4gbmV4dCgpXG4gICAgfVxuICB9XG59XG4iXSwibmFtZXMiOlsiZ2V0U3RhdGljSGFuZGxlciIsImNhY2hpbmdPcHRpb25zIiwiY29sbGVjdGlvbiIsIm1heEFnZSIsImNvbGxDYWNoZUNvbmZpZyIsImNvbGxlY3Rpb25zIiwic2x1ZyIsImNhY2hpbmdFbmFibGVkIiwicHJvY2VzcyIsImVudiIsIlBBWUxPQURfQ0xPVURfQ0FDSEVfS0VZIiwiZW5hYmxlZCIsInJlcSIsInJlcyIsIm5leHQiLCJmaWxlbmFtZSIsInBhcmFtcyIsImZpbGVLZXlXaXRoUHJlZml4IiwicGF5bG9hZCIsImxvZ2dlciIsIndhcm4iLCJtc2ciLCJpZGVudGl0eUlEIiwic3RvcmFnZUNsaWVudCIsImdldFN0b3JhZ2VDbGllbnQiLCJjcmVhdGVLZXkiLCJvYmplY3QiLCJnZXRPYmplY3QiLCJCdWNrZXQiLCJQQVlMT0FEX0NMT1VEX0JVQ0tFVCIsIktleSIsInNldCIsIkNvbnRlbnRMZW5ndGgiLCJDb250ZW50VHlwZSIsIkVUYWciLCJCb2R5IiwicGlwZSIsImVyciIsImVycm9yIl0sInJhbmdlTWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzsiLCJtYXBwaW5ncyI6Ijs7OzsrQkFhYUE7OztlQUFBQTs7OzJCQVJhO2tDQUNPO0FBTzFCLE1BQU1BLG1CQUFtQixDQUFDLEVBQUVDLGNBQWMsRUFBRUMsVUFBVSxFQUFRO0lBQ25FLElBQUlDLFNBQVMsTUFBTSxtQkFBbUI7O0lBQ3RDLElBQUlDO0lBQ0osSUFBSUgsbUJBQW1CLE9BQU87UUFDNUIsd0NBQXdDO1FBQ3hDRSxTQUFTRixnQkFBZ0JFLFVBQVVBO1FBQ25DQyxrQkFBa0JILGdCQUFnQkksYUFBYSxDQUFDSCxXQUFXSSxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3ZFO0lBRUEsZ0RBQWdEO0lBQ2hESCxTQUFTQyxpQkFBaUJELFVBQVVBO0lBRXBDLE1BQU1JLGlCQUNKTixtQkFBbUIsU0FDbkIsQ0FBQyxDQUFDTyxRQUFRQyxHQUFHLENBQUNDLHVCQUF1QixJQUNyQ04saUJBQWlCTyxZQUFZO0lBRS9CLE9BQU8sT0FBT0MsS0FBS0MsS0FBS0M7UUFDdEIsTUFBTUMsV0FBV0gsSUFBSUksTUFBTSxDQUFDRCxRQUFRO1FBQ3BDLElBQUlFLG9CQUFvQjtRQUV4QixJQUFJLENBQUNGLFVBQVU7WUFDYkgsSUFBSU0sT0FBTyxDQUFDQyxNQUFNLENBQUNDLElBQUksQ0FBQztnQkFDdEJDLEtBQUssQ0FBQyx5REFBeUQsRUFBRW5CLFdBQVdJLElBQUksQ0FBQyxDQUFDO1lBQ3BGO1FBQ0Y7UUFFQSxJQUFJO1lBQ0YsTUFBTSxFQUFFZ0IsVUFBVSxFQUFFQyxhQUFhLEVBQUUsR0FBRyxNQUFNQyxJQUFBQSxrQ0FBZ0I7WUFFNURQLG9CQUFvQlEsSUFBQUEsb0JBQVMsRUFBQztnQkFDNUJ2QixZQUFZQSxXQUFXSSxJQUFJO2dCQUMzQlM7Z0JBQ0FPO1lBQ0Y7WUFFQSxNQUFNSSxTQUFTLE1BQU1ILGNBQWNJLFNBQVMsQ0FBQztnQkFDM0NDLFFBQVFwQixRQUFRQyxHQUFHLENBQUNvQixvQkFBb0I7Z0JBQ3hDQyxLQUFLYjtZQUNQO1lBRUFKLElBQUlrQixHQUFHLENBQUM7Z0JBQ04sa0JBQWtCTCxPQUFPTSxhQUFhO2dCQUN0QyxnQkFBZ0JOLE9BQU9PLFdBQVc7Z0JBQ2xDLEdBQUkxQixrQkFBa0I7b0JBQUUsaUJBQWlCLENBQUMsZ0JBQWdCLEVBQUVKLE9BQU8sQ0FBQztnQkFBQyxDQUFDO2dCQUN0RStCLE1BQU1SLE9BQU9RLElBQUk7WUFDbkI7WUFFQSxJQUFJUixRQUFRUyxNQUFNO2dCQUNoQixPQUFPLEFBQUNULE9BQU9TLElBQUksQ0FBY0MsSUFBSSxDQUFDdkI7WUFDeEM7WUFFQSxPQUFPQztRQUNULEVBQUUsT0FBT3VCLEtBQWM7WUFDckJ6QixJQUFJTSxPQUFPLENBQUNDLE1BQU0sQ0FBQ21CLEtBQUssQ0FBQztnQkFDdkJEO2dCQUNBaEIsS0FBSyxDQUFDLHdDQUF3QyxFQUFFSixrQkFBa0IsQ0FBQyxDQUFDO1lBQ3RFO1lBQ0EsT0FBT0g7UUFDVDtJQUNGO0FBQ0YifQ==