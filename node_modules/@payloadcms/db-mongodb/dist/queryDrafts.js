"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "queryDrafts", {
    enumerable: true,
    get: function() {
        return queryDrafts;
    }
});
const _database = require("payload/database");
const _buildSortParam = require("./queries/buildSortParam");
const _sanitizeInternalFields = /*#__PURE__*/ _interop_require_default(require("./utilities/sanitizeInternalFields"));
const _withSession = require("./withSession");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const queryDrafts = async function queryDrafts({ collection, limit, locale, page, pagination, req = {}, sort: sortArg, where }) {
    const VersionModel = this.versions[collection];
    const collectionConfig = this.payload.collections[collection].config;
    const options = await (0, _withSession.withSession)(this, req);
    let hasNearConstraint;
    let sort;
    if (where) {
        const constraints = (0, _database.flattenWhereToOperators)(where);
        hasNearConstraint = constraints.some((prop)=>Object.keys(prop).some((key)=>key === 'near'));
    }
    if (!hasNearConstraint) {
        sort = (0, _buildSortParam.buildSortParam)({
            config: this.payload.config,
            fields: collectionConfig.fields,
            locale,
            sort: sortArg || collectionConfig.defaultSort,
            timestamps: true
        });
    }
    const combinedWhere = (0, _database.combineQueries)({
        latest: {
            equals: true
        }
    }, where);
    const versionQuery = await VersionModel.buildQuery({
        locale,
        payload: this.payload,
        where: combinedWhere
    });
    // useEstimatedCount is faster, but not accurate, as it ignores any filters. It is thus set to true if there are no filters.
    const useEstimatedCount = hasNearConstraint || !versionQuery || Object.keys(versionQuery).length === 0;
    const paginationOptions = {
        forceCountFn: hasNearConstraint,
        lean: true,
        leanWithId: true,
        options,
        page,
        pagination,
        sort,
        useEstimatedCount
    };
    if (this.collation) {
        const defaultLocale = 'en';
        paginationOptions.collation = {
            locale: locale && locale !== 'all' && locale !== '*' ? locale : defaultLocale,
            ...this.collation
        };
    }
    if (!useEstimatedCount && Object.keys(versionQuery).length === 0 && this.disableIndexHints !== true) {
        // Improve the performance of the countDocuments query which is used if useEstimatedCount is set to false by adding
        // a hint. By default, if no hint is provided, MongoDB does not use an indexed field to count the returned documents,
        // which makes queries very slow. This only happens when no query (filter) is provided. If one is provided, it uses
        // the correct indexed field
        paginationOptions.useCustomCountFn = ()=>{
            return Promise.resolve(VersionModel.countDocuments(versionQuery, {
                hint: {
                    _id: 1
                }
            }));
        };
    }
    if (limit > 0) {
        paginationOptions.limit = limit;
        // limit must also be set here, it's ignored when pagination is false
        paginationOptions.options.limit = limit;
    }
    const result = await VersionModel.paginate(versionQuery, paginationOptions);
    const docs = this.jsonParse ? JSON.parse(JSON.stringify(result.docs)) : result.docs;
    return {
        ...result,
        docs: docs.map((doc)=>{
            // eslint-disable-next-line no-param-reassign
            doc = {
                _id: doc.parent,
                id: doc.parent,
                ...doc.version,
                createdAt: doc.createdAt,
                updatedAt: doc.updatedAt
            };
            return (0, _sanitizeInternalFields.default)(doc);
        })
    };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9xdWVyeURyYWZ0cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFBhZ2luYXRlT3B0aW9ucyB9IGZyb20gJ21vbmdvb3NlJ1xuaW1wb3J0IHR5cGUgeyBRdWVyeURyYWZ0cyB9IGZyb20gJ3BheWxvYWQvZGF0YWJhc2UnXG5pbXBvcnQgdHlwZSB7IFBheWxvYWRSZXF1ZXN0IH0gZnJvbSAncGF5bG9hZC90eXBlcydcblxuaW1wb3J0IHsgY29tYmluZVF1ZXJpZXMsIGZsYXR0ZW5XaGVyZVRvT3BlcmF0b3JzIH0gZnJvbSAncGF5bG9hZC9kYXRhYmFzZSdcblxuaW1wb3J0IHR5cGUgeyBNb25nb29zZUFkYXB0ZXIgfSBmcm9tICcuJ1xuXG5pbXBvcnQgeyBidWlsZFNvcnRQYXJhbSB9IGZyb20gJy4vcXVlcmllcy9idWlsZFNvcnRQYXJhbSdcbmltcG9ydCBzYW5pdGl6ZUludGVybmFsRmllbGRzIGZyb20gJy4vdXRpbGl0aWVzL3Nhbml0aXplSW50ZXJuYWxGaWVsZHMnXG5pbXBvcnQgeyB3aXRoU2Vzc2lvbiB9IGZyb20gJy4vd2l0aFNlc3Npb24nXG5cbmV4cG9ydCBjb25zdCBxdWVyeURyYWZ0czogUXVlcnlEcmFmdHMgPSBhc3luYyBmdW5jdGlvbiBxdWVyeURyYWZ0cyhcbiAgdGhpczogTW9uZ29vc2VBZGFwdGVyLFxuICB7IGNvbGxlY3Rpb24sIGxpbWl0LCBsb2NhbGUsIHBhZ2UsIHBhZ2luYXRpb24sIHJlcSA9IHt9IGFzIFBheWxvYWRSZXF1ZXN0LCBzb3J0OiBzb3J0QXJnLCB3aGVyZSB9LFxuKSB7XG4gIGNvbnN0IFZlcnNpb25Nb2RlbCA9IHRoaXMudmVyc2lvbnNbY29sbGVjdGlvbl1cbiAgY29uc3QgY29sbGVjdGlvbkNvbmZpZyA9IHRoaXMucGF5bG9hZC5jb2xsZWN0aW9uc1tjb2xsZWN0aW9uXS5jb25maWdcbiAgY29uc3Qgb3B0aW9ucyA9IGF3YWl0IHdpdGhTZXNzaW9uKHRoaXMsIHJlcSlcblxuICBsZXQgaGFzTmVhckNvbnN0cmFpbnRcbiAgbGV0IHNvcnRcblxuICBpZiAod2hlcmUpIHtcbiAgICBjb25zdCBjb25zdHJhaW50cyA9IGZsYXR0ZW5XaGVyZVRvT3BlcmF0b3JzKHdoZXJlKVxuICAgIGhhc05lYXJDb25zdHJhaW50ID0gY29uc3RyYWludHMuc29tZSgocHJvcCkgPT4gT2JqZWN0LmtleXMocHJvcCkuc29tZSgoa2V5KSA9PiBrZXkgPT09ICduZWFyJykpXG4gIH1cblxuICBpZiAoIWhhc05lYXJDb25zdHJhaW50KSB7XG4gICAgc29ydCA9IGJ1aWxkU29ydFBhcmFtKHtcbiAgICAgIGNvbmZpZzogdGhpcy5wYXlsb2FkLmNvbmZpZyxcbiAgICAgIGZpZWxkczogY29sbGVjdGlvbkNvbmZpZy5maWVsZHMsXG4gICAgICBsb2NhbGUsXG4gICAgICBzb3J0OiBzb3J0QXJnIHx8IGNvbGxlY3Rpb25Db25maWcuZGVmYXVsdFNvcnQsXG4gICAgICB0aW1lc3RhbXBzOiB0cnVlLFxuICAgIH0pXG4gIH1cblxuICBjb25zdCBjb21iaW5lZFdoZXJlID0gY29tYmluZVF1ZXJpZXMoeyBsYXRlc3Q6IHsgZXF1YWxzOiB0cnVlIH0gfSwgd2hlcmUpXG5cbiAgY29uc3QgdmVyc2lvblF1ZXJ5ID0gYXdhaXQgVmVyc2lvbk1vZGVsLmJ1aWxkUXVlcnkoe1xuICAgIGxvY2FsZSxcbiAgICBwYXlsb2FkOiB0aGlzLnBheWxvYWQsXG4gICAgd2hlcmU6IGNvbWJpbmVkV2hlcmUsXG4gIH0pXG5cbiAgLy8gdXNlRXN0aW1hdGVkQ291bnQgaXMgZmFzdGVyLCBidXQgbm90IGFjY3VyYXRlLCBhcyBpdCBpZ25vcmVzIGFueSBmaWx0ZXJzLiBJdCBpcyB0aHVzIHNldCB0byB0cnVlIGlmIHRoZXJlIGFyZSBubyBmaWx0ZXJzLlxuICBjb25zdCB1c2VFc3RpbWF0ZWRDb3VudCA9XG4gICAgaGFzTmVhckNvbnN0cmFpbnQgfHwgIXZlcnNpb25RdWVyeSB8fCBPYmplY3Qua2V5cyh2ZXJzaW9uUXVlcnkpLmxlbmd0aCA9PT0gMFxuICBjb25zdCBwYWdpbmF0aW9uT3B0aW9uczogUGFnaW5hdGVPcHRpb25zID0ge1xuICAgIGZvcmNlQ291bnRGbjogaGFzTmVhckNvbnN0cmFpbnQsXG4gICAgbGVhbjogdHJ1ZSxcbiAgICBsZWFuV2l0aElkOiB0cnVlLFxuICAgIG9wdGlvbnMsXG4gICAgcGFnZSxcbiAgICBwYWdpbmF0aW9uLFxuICAgIHNvcnQsXG4gICAgdXNlRXN0aW1hdGVkQ291bnQsXG4gIH1cblxuICBpZiAodGhpcy5jb2xsYXRpb24pIHtcbiAgICBjb25zdCBkZWZhdWx0TG9jYWxlID0gJ2VuJ1xuICAgIHBhZ2luYXRpb25PcHRpb25zLmNvbGxhdGlvbiA9IHtcbiAgICAgIGxvY2FsZTogbG9jYWxlICYmIGxvY2FsZSAhPT0gJ2FsbCcgJiYgbG9jYWxlICE9PSAnKicgPyBsb2NhbGUgOiBkZWZhdWx0TG9jYWxlLFxuICAgICAgLi4udGhpcy5jb2xsYXRpb24sXG4gICAgfVxuICB9XG5cbiAgaWYgKFxuICAgICF1c2VFc3RpbWF0ZWRDb3VudCAmJlxuICAgIE9iamVjdC5rZXlzKHZlcnNpb25RdWVyeSkubGVuZ3RoID09PSAwICYmXG4gICAgdGhpcy5kaXNhYmxlSW5kZXhIaW50cyAhPT0gdHJ1ZVxuICApIHtcbiAgICAvLyBJbXByb3ZlIHRoZSBwZXJmb3JtYW5jZSBvZiB0aGUgY291bnREb2N1bWVudHMgcXVlcnkgd2hpY2ggaXMgdXNlZCBpZiB1c2VFc3RpbWF0ZWRDb3VudCBpcyBzZXQgdG8gZmFsc2UgYnkgYWRkaW5nXG4gICAgLy8gYSBoaW50LiBCeSBkZWZhdWx0LCBpZiBubyBoaW50IGlzIHByb3ZpZGVkLCBNb25nb0RCIGRvZXMgbm90IHVzZSBhbiBpbmRleGVkIGZpZWxkIHRvIGNvdW50IHRoZSByZXR1cm5lZCBkb2N1bWVudHMsXG4gICAgLy8gd2hpY2ggbWFrZXMgcXVlcmllcyB2ZXJ5IHNsb3cuIFRoaXMgb25seSBoYXBwZW5zIHdoZW4gbm8gcXVlcnkgKGZpbHRlcikgaXMgcHJvdmlkZWQuIElmIG9uZSBpcyBwcm92aWRlZCwgaXQgdXNlc1xuICAgIC8vIHRoZSBjb3JyZWN0IGluZGV4ZWQgZmllbGRcbiAgICBwYWdpbmF0aW9uT3B0aW9ucy51c2VDdXN0b21Db3VudEZuID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcbiAgICAgICAgVmVyc2lvbk1vZGVsLmNvdW50RG9jdW1lbnRzKHZlcnNpb25RdWVyeSwge1xuICAgICAgICAgIGhpbnQ6IHsgX2lkOiAxIH0sXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGlmIChsaW1pdCA+IDApIHtcbiAgICBwYWdpbmF0aW9uT3B0aW9ucy5saW1pdCA9IGxpbWl0XG4gICAgLy8gbGltaXQgbXVzdCBhbHNvIGJlIHNldCBoZXJlLCBpdCdzIGlnbm9yZWQgd2hlbiBwYWdpbmF0aW9uIGlzIGZhbHNlXG4gICAgcGFnaW5hdGlvbk9wdGlvbnMub3B0aW9ucy5saW1pdCA9IGxpbWl0XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBWZXJzaW9uTW9kZWwucGFnaW5hdGUodmVyc2lvblF1ZXJ5LCBwYWdpbmF0aW9uT3B0aW9ucylcblxuICBjb25zdCBkb2NzID0gdGhpcy5qc29uUGFyc2UgPyBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdC5kb2NzKSkgOiByZXN1bHQuZG9jc1xuXG4gIHJldHVybiB7XG4gICAgLi4ucmVzdWx0LFxuICAgIGRvY3M6IGRvY3MubWFwKChkb2MpID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuXG4gICAgICBkb2MgPSB7XG4gICAgICAgIF9pZDogZG9jLnBhcmVudCxcbiAgICAgICAgaWQ6IGRvYy5wYXJlbnQsXG4gICAgICAgIC4uLmRvYy52ZXJzaW9uLFxuICAgICAgICBjcmVhdGVkQXQ6IGRvYy5jcmVhdGVkQXQsXG4gICAgICAgIHVwZGF0ZWRBdDogZG9jLnVwZGF0ZWRBdCxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNhbml0aXplSW50ZXJuYWxGaWVsZHMoZG9jKVxuICAgIH0pLFxuICB9XG59XG4iXSwibmFtZXMiOlsicXVlcnlEcmFmdHMiLCJjb2xsZWN0aW9uIiwibGltaXQiLCJsb2NhbGUiLCJwYWdlIiwicGFnaW5hdGlvbiIsInJlcSIsInNvcnQiLCJzb3J0QXJnIiwid2hlcmUiLCJWZXJzaW9uTW9kZWwiLCJ2ZXJzaW9ucyIsImNvbGxlY3Rpb25Db25maWciLCJwYXlsb2FkIiwiY29sbGVjdGlvbnMiLCJjb25maWciLCJvcHRpb25zIiwid2l0aFNlc3Npb24iLCJoYXNOZWFyQ29uc3RyYWludCIsImNvbnN0cmFpbnRzIiwiZmxhdHRlbldoZXJlVG9PcGVyYXRvcnMiLCJzb21lIiwicHJvcCIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJidWlsZFNvcnRQYXJhbSIsImZpZWxkcyIsImRlZmF1bHRTb3J0IiwidGltZXN0YW1wcyIsImNvbWJpbmVkV2hlcmUiLCJjb21iaW5lUXVlcmllcyIsImxhdGVzdCIsImVxdWFscyIsInZlcnNpb25RdWVyeSIsImJ1aWxkUXVlcnkiLCJ1c2VFc3RpbWF0ZWRDb3VudCIsImxlbmd0aCIsInBhZ2luYXRpb25PcHRpb25zIiwiZm9yY2VDb3VudEZuIiwibGVhbiIsImxlYW5XaXRoSWQiLCJjb2xsYXRpb24iLCJkZWZhdWx0TG9jYWxlIiwiZGlzYWJsZUluZGV4SGludHMiLCJ1c2VDdXN0b21Db3VudEZuIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjb3VudERvY3VtZW50cyIsImhpbnQiLCJfaWQiLCJyZXN1bHQiLCJwYWdpbmF0ZSIsImRvY3MiLCJqc29uUGFyc2UiLCJKU09OIiwicGFyc2UiLCJzdHJpbmdpZnkiLCJtYXAiLCJkb2MiLCJwYXJlbnQiLCJpZCIsInZlcnNpb24iLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJzYW5pdGl6ZUludGVybmFsRmllbGRzIl0sInJhbmdlTWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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