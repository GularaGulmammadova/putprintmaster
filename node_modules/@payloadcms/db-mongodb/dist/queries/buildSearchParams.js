"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "buildSearchParam", {
    enumerable: true,
    get: function() {
        return buildSearchParam;
    }
});
const _bsonobjectid = /*#__PURE__*/ _interop_require_default(require("bson-objectid"));
const _mongoose = /*#__PURE__*/ _interop_require_default(require("mongoose"));
const _database = require("payload/database");
const _types = require("payload/types");
const _operatorMap = require("./operatorMap");
const _sanitizeQueryValue = require("./sanitizeQueryValue");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const ObjectId = _bsonobjectid.default;
const subQueryOptions = {
    lean: true,
    limit: 50
};
async function buildSearchParam({ collectionSlug, fields, globalSlug, incomingPath, locale, operator, payload, val }) {
    // Replace GraphQL nested field double underscore formatting
    let sanitizedPath = incomingPath.replace(/__/g, '.');
    if (sanitizedPath === 'id') sanitizedPath = '_id';
    let paths = [];
    let hasCustomID = false;
    if (sanitizedPath === '_id') {
        const customIDfield = payload.collections[collectionSlug]?.config.fields.find((field)=>(0, _types.fieldAffectsData)(field) && field.name === 'id');
        let idFieldType = 'text';
        if (customIDfield) {
            if (customIDfield?.type === 'text' || customIDfield?.type === 'number') {
                idFieldType = customIDfield.type;
            }
            hasCustomID = true;
        }
        paths.push({
            collectionSlug,
            complete: true,
            field: {
                name: 'id',
                type: idFieldType
            },
            path: '_id'
        });
    } else {
        paths = await (0, _database.getLocalizedPaths)({
            collectionSlug,
            fields,
            globalSlug,
            incomingPath: sanitizedPath,
            locale,
            payload
        });
    }
    const [{ field, path }] = paths;
    if (path) {
        const { operator: formattedOperator, rawQuery, val: formattedValue } = (0, _sanitizeQueryValue.sanitizeQueryValue)({
            field,
            hasCustomID,
            operator,
            path,
            val
        });
        if (rawQuery) return {
            value: rawQuery
        };
        // If there are multiple collections to search through,
        // Recursively build up a list of query constraints
        if (paths.length > 1) {
            // Remove top collection and reverse array
            // to work backwards from top
            const pathsToQuery = paths.slice(1).reverse();
            const initialRelationshipQuery = {
                value: {}
            };
            const relationshipQuery = await pathsToQuery.reduce(async (priorQuery, { collectionSlug: slug, path: subPath }, i)=>{
                const priorQueryResult = await priorQuery;
                const SubModel = payload.db.collections[slug];
                // On the "deepest" collection,
                // Search on the value passed through the query
                if (i === 0) {
                    const subQuery = await SubModel.buildQuery({
                        locale,
                        payload,
                        where: {
                            [subPath]: {
                                [formattedOperator]: val
                            }
                        }
                    });
                    const result = await SubModel.find(subQuery, subQueryOptions);
                    const $in = [];
                    result.forEach((doc)=>{
                        const stringID = doc._id.toString();
                        $in.push(stringID);
                        if (_mongoose.default.Types.ObjectId.isValid(stringID)) {
                            $in.push(doc._id);
                        }
                    });
                    if (pathsToQuery.length === 1) {
                        return {
                            path,
                            value: {
                                $in
                            }
                        };
                    }
                    const nextSubPath = pathsToQuery[i + 1].path;
                    return {
                        value: {
                            [nextSubPath]: {
                                $in
                            }
                        }
                    };
                }
                const subQuery = priorQueryResult.value;
                const result = await SubModel.find(subQuery, subQueryOptions);
                const $in = result.map((doc)=>doc._id.toString());
                // If it is the last recursion
                // then pass through the search param
                if (i + 1 === pathsToQuery.length) {
                    return {
                        path,
                        value: {
                            $in
                        }
                    };
                }
                return {
                    value: {
                        _id: {
                            $in
                        }
                    }
                };
            }, Promise.resolve(initialRelationshipQuery));
            return relationshipQuery;
        }
        if (formattedOperator && _types.validOperators.includes(formattedOperator)) {
            const operatorKey = _operatorMap.operatorMap[formattedOperator];
            if (field.type === 'relationship' || field.type === 'upload') {
                let hasNumberIDRelation;
                let multiIDCondition = '$or';
                if (operatorKey === '$ne') multiIDCondition = '$and';
                const result = {
                    value: {
                        [multiIDCondition]: [
                            {
                                [path]: {
                                    [operatorKey]: formattedValue
                                }
                            }
                        ]
                    }
                };
                if (typeof formattedValue === 'string') {
                    if (_mongoose.default.Types.ObjectId.isValid(formattedValue)) {
                        result.value[multiIDCondition].push({
                            [path]: {
                                [operatorKey]: ObjectId(formattedValue)
                            }
                        });
                    } else {
                        (Array.isArray(field.relationTo) ? field.relationTo : [
                            field.relationTo
                        ]).forEach((relationTo)=>{
                            const isRelatedToCustomNumberID = payload.collections[relationTo]?.config?.fields.find((relatedField)=>{
                                return (0, _types.fieldAffectsData)(relatedField) && relatedField.name === 'id' && relatedField.type === 'number';
                            });
                            if (isRelatedToCustomNumberID) {
                                if (isRelatedToCustomNumberID.type === 'number') hasNumberIDRelation = true;
                            }
                        });
                        if (hasNumberIDRelation) result.value[multiIDCondition].push({
                            [path]: {
                                [operatorKey]: parseFloat(formattedValue)
                            }
                        });
                    }
                }
                if (result.value[multiIDCondition].length > 1) {
                    return result;
                }
            }
            if (formattedOperator === 'like' && typeof formattedValue === 'string') {
                const words = formattedValue.split(' ');
                const result = {
                    value: {
                        $and: words.map((word)=>({
                                [path]: {
                                    $options: 'i',
                                    $regex: word.replace(/[\\^$*+?.()|[\]{}]/g, '\\$&')
                                }
                            }))
                    }
                };
                return result;
            }
            // Some operators like 'near' need to define a full query
            // so if there is no operator key, just return the value
            if (!operatorKey) {
                return {
                    path,
                    value: formattedValue
                };
            }
            return {
                path,
                value: {
                    [operatorKey]: formattedValue
                }
            };
        }
    }
    return undefined;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL2J1aWxkU2VhcmNoUGFyYW1zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUGF5bG9hZCB9IGZyb20gJ3BheWxvYWQnXG5pbXBvcnQgdHlwZSB7IFBhdGhUb1F1ZXJ5IH0gZnJvbSAncGF5bG9hZC9kYXRhYmFzZSdcbmltcG9ydCB0eXBlIHsgRmllbGQgfSBmcm9tICdwYXlsb2FkL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBPcGVyYXRvciB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5cbmltcG9ydCBPYmplY3RJZEltcG9ydCBmcm9tICdic29uLW9iamVjdGlkJ1xuaW1wb3J0IG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJ1xuaW1wb3J0IHsgZ2V0TG9jYWxpemVkUGF0aHMgfSBmcm9tICdwYXlsb2FkL2RhdGFiYXNlJ1xuaW1wb3J0IHsgZmllbGRBZmZlY3RzRGF0YSB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5pbXBvcnQgeyB2YWxpZE9wZXJhdG9ycyB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5cbmltcG9ydCB0eXBlIHsgTW9uZ29vc2VBZGFwdGVyIH0gZnJvbSAnLi4nXG5cbmltcG9ydCB7IG9wZXJhdG9yTWFwIH0gZnJvbSAnLi9vcGVyYXRvck1hcCdcbmltcG9ydCB7IHNhbml0aXplUXVlcnlWYWx1ZSB9IGZyb20gJy4vc2FuaXRpemVRdWVyeVZhbHVlJ1xuXG5jb25zdCBPYmplY3RJZCA9IE9iamVjdElkSW1wb3J0XG5cbnR5cGUgU2VhcmNoUGFyYW0gPSB7XG4gIHBhdGg/OiBzdHJpbmdcbiAgcmF3UXVlcnk/OiB1bmtub3duXG4gIHZhbHVlPzogdW5rbm93blxufVxuXG5jb25zdCBzdWJRdWVyeU9wdGlvbnMgPSB7XG4gIGxlYW46IHRydWUsXG4gIGxpbWl0OiA1MCxcbn1cblxuLyoqXG4gKiBDb252ZXJ0IHRoZSBQYXlsb2FkIGtleSAvIHZhbHVlIC8gb3BlcmF0b3IgaW50byBhIE1vbmdvREIgcXVlcnlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkU2VhcmNoUGFyYW0oe1xuICBjb2xsZWN0aW9uU2x1ZyxcbiAgZmllbGRzLFxuICBnbG9iYWxTbHVnLFxuICBpbmNvbWluZ1BhdGgsXG4gIGxvY2FsZSxcbiAgb3BlcmF0b3IsXG4gIHBheWxvYWQsXG4gIHZhbCxcbn06IHtcbiAgY29sbGVjdGlvblNsdWc/OiBzdHJpbmdcbiAgZmllbGRzOiBGaWVsZFtdXG4gIGdsb2JhbFNsdWc/OiBzdHJpbmdcbiAgaW5jb21pbmdQYXRoOiBzdHJpbmdcbiAgbG9jYWxlPzogc3RyaW5nXG4gIG9wZXJhdG9yOiBzdHJpbmdcbiAgcGF5bG9hZDogUGF5bG9hZFxuICB2YWw6IHVua25vd25cbn0pOiBQcm9taXNlPFNlYXJjaFBhcmFtPiB7XG4gIC8vIFJlcGxhY2UgR3JhcGhRTCBuZXN0ZWQgZmllbGQgZG91YmxlIHVuZGVyc2NvcmUgZm9ybWF0dGluZ1xuICBsZXQgc2FuaXRpemVkUGF0aCA9IGluY29taW5nUGF0aC5yZXBsYWNlKC9fXy9nLCAnLicpXG4gIGlmIChzYW5pdGl6ZWRQYXRoID09PSAnaWQnKSBzYW5pdGl6ZWRQYXRoID0gJ19pZCdcblxuICBsZXQgcGF0aHM6IFBhdGhUb1F1ZXJ5W10gPSBbXVxuXG4gIGxldCBoYXNDdXN0b21JRCA9IGZhbHNlXG5cbiAgaWYgKHNhbml0aXplZFBhdGggPT09ICdfaWQnKSB7XG4gICAgY29uc3QgY3VzdG9tSURmaWVsZCA9IHBheWxvYWQuY29sbGVjdGlvbnNbY29sbGVjdGlvblNsdWddPy5jb25maWcuZmllbGRzLmZpbmQoXG4gICAgICAoZmllbGQpID0+IGZpZWxkQWZmZWN0c0RhdGEoZmllbGQpICYmIGZpZWxkLm5hbWUgPT09ICdpZCcsXG4gICAgKVxuXG4gICAgbGV0IGlkRmllbGRUeXBlOiAnbnVtYmVyJyB8ICd0ZXh0JyA9ICd0ZXh0J1xuXG4gICAgaWYgKGN1c3RvbUlEZmllbGQpIHtcbiAgICAgIGlmIChjdXN0b21JRGZpZWxkPy50eXBlID09PSAndGV4dCcgfHwgY3VzdG9tSURmaWVsZD8udHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgaWRGaWVsZFR5cGUgPSBjdXN0b21JRGZpZWxkLnR5cGVcbiAgICAgIH1cblxuICAgICAgaGFzQ3VzdG9tSUQgPSB0cnVlXG4gICAgfVxuXG4gICAgcGF0aHMucHVzaCh7XG4gICAgICBjb2xsZWN0aW9uU2x1ZyxcbiAgICAgIGNvbXBsZXRlOiB0cnVlLFxuICAgICAgZmllbGQ6IHtcbiAgICAgICAgbmFtZTogJ2lkJyxcbiAgICAgICAgdHlwZTogaWRGaWVsZFR5cGUsXG4gICAgICB9IGFzIEZpZWxkLFxuICAgICAgcGF0aDogJ19pZCcsXG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICBwYXRocyA9IGF3YWl0IGdldExvY2FsaXplZFBhdGhzKHtcbiAgICAgIGNvbGxlY3Rpb25TbHVnLFxuICAgICAgZmllbGRzLFxuICAgICAgZ2xvYmFsU2x1ZyxcbiAgICAgIGluY29taW5nUGF0aDogc2FuaXRpemVkUGF0aCxcbiAgICAgIGxvY2FsZSxcbiAgICAgIHBheWxvYWQsXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IFt7IGZpZWxkLCBwYXRoIH1dID0gcGF0aHNcblxuICBpZiAocGF0aCkge1xuICAgIGNvbnN0IHtcbiAgICAgIG9wZXJhdG9yOiBmb3JtYXR0ZWRPcGVyYXRvcixcbiAgICAgIHJhd1F1ZXJ5LFxuICAgICAgdmFsOiBmb3JtYXR0ZWRWYWx1ZSxcbiAgICB9ID0gc2FuaXRpemVRdWVyeVZhbHVlKHtcbiAgICAgIGZpZWxkLFxuICAgICAgaGFzQ3VzdG9tSUQsXG4gICAgICBvcGVyYXRvcixcbiAgICAgIHBhdGgsXG4gICAgICB2YWwsXG4gICAgfSlcblxuICAgIGlmIChyYXdRdWVyeSkgcmV0dXJuIHsgdmFsdWU6IHJhd1F1ZXJ5IH1cblxuICAgIC8vIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBjb2xsZWN0aW9ucyB0byBzZWFyY2ggdGhyb3VnaCxcbiAgICAvLyBSZWN1cnNpdmVseSBidWlsZCB1cCBhIGxpc3Qgb2YgcXVlcnkgY29uc3RyYWludHNcbiAgICBpZiAocGF0aHMubGVuZ3RoID4gMSkge1xuICAgICAgLy8gUmVtb3ZlIHRvcCBjb2xsZWN0aW9uIGFuZCByZXZlcnNlIGFycmF5XG4gICAgICAvLyB0byB3b3JrIGJhY2t3YXJkcyBmcm9tIHRvcFxuICAgICAgY29uc3QgcGF0aHNUb1F1ZXJ5ID0gcGF0aHMuc2xpY2UoMSkucmV2ZXJzZSgpXG5cbiAgICAgIGNvbnN0IGluaXRpYWxSZWxhdGlvbnNoaXBRdWVyeSA9IHtcbiAgICAgICAgdmFsdWU6IHt9LFxuICAgICAgfSBhcyBTZWFyY2hQYXJhbVxuXG4gICAgICBjb25zdCByZWxhdGlvbnNoaXBRdWVyeSA9IGF3YWl0IHBhdGhzVG9RdWVyeS5yZWR1Y2UoXG4gICAgICAgIGFzeW5jIChwcmlvclF1ZXJ5LCB7IGNvbGxlY3Rpb25TbHVnOiBzbHVnLCBwYXRoOiBzdWJQYXRoIH0sIGkpID0+IHtcbiAgICAgICAgICBjb25zdCBwcmlvclF1ZXJ5UmVzdWx0ID0gYXdhaXQgcHJpb3JRdWVyeVxuXG4gICAgICAgICAgY29uc3QgU3ViTW9kZWwgPSAocGF5bG9hZC5kYiBhcyBNb25nb29zZUFkYXB0ZXIpLmNvbGxlY3Rpb25zW3NsdWddXG5cbiAgICAgICAgICAvLyBPbiB0aGUgXCJkZWVwZXN0XCIgY29sbGVjdGlvbixcbiAgICAgICAgICAvLyBTZWFyY2ggb24gdGhlIHZhbHVlIHBhc3NlZCB0aHJvdWdoIHRoZSBxdWVyeVxuICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJRdWVyeSA9IGF3YWl0IFN1Yk1vZGVsLmJ1aWxkUXVlcnkoe1xuICAgICAgICAgICAgICBsb2NhbGUsXG4gICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICAgICAgW3N1YlBhdGhdOiB7XG4gICAgICAgICAgICAgICAgICBbZm9ybWF0dGVkT3BlcmF0b3JdOiB2YWwsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFN1Yk1vZGVsLmZpbmQoc3ViUXVlcnksIHN1YlF1ZXJ5T3B0aW9ucylcblxuICAgICAgICAgICAgY29uc3QgJGluOiB1bmtub3duW10gPSBbXVxuXG4gICAgICAgICAgICByZXN1bHQuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHN0cmluZ0lEID0gZG9jLl9pZC50b1N0cmluZygpXG4gICAgICAgICAgICAgICRpbi5wdXNoKHN0cmluZ0lEKVxuXG4gICAgICAgICAgICAgIGlmIChtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKHN0cmluZ0lEKSkge1xuICAgICAgICAgICAgICAgICRpbi5wdXNoKGRvYy5faWQpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIGlmIChwYXRoc1RvUXVlcnkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogeyAkaW4gfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBuZXh0U3ViUGF0aCA9IHBhdGhzVG9RdWVyeVtpICsgMV0ucGF0aFxuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICB2YWx1ZTogeyBbbmV4dFN1YlBhdGhdOiB7ICRpbiB9IH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3Qgc3ViUXVlcnkgPSBwcmlvclF1ZXJ5UmVzdWx0LnZhbHVlXG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgU3ViTW9kZWwuZmluZChzdWJRdWVyeSwgc3ViUXVlcnlPcHRpb25zKVxuXG4gICAgICAgICAgY29uc3QgJGluID0gcmVzdWx0Lm1hcCgoZG9jKSA9PiBkb2MuX2lkLnRvU3RyaW5nKCkpXG5cbiAgICAgICAgICAvLyBJZiBpdCBpcyB0aGUgbGFzdCByZWN1cnNpb25cbiAgICAgICAgICAvLyB0aGVuIHBhc3MgdGhyb3VnaCB0aGUgc2VhcmNoIHBhcmFtXG4gICAgICAgICAgaWYgKGkgKyAxID09PSBwYXRoc1RvUXVlcnkubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBwYXRoLFxuICAgICAgICAgICAgICB2YWx1ZTogeyAkaW4gfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdmFsdWU6IHtcbiAgICAgICAgICAgICAgX2lkOiB7ICRpbiB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFByb21pc2UucmVzb2x2ZShpbml0aWFsUmVsYXRpb25zaGlwUXVlcnkpLFxuICAgICAgKVxuXG4gICAgICByZXR1cm4gcmVsYXRpb25zaGlwUXVlcnlcbiAgICB9XG5cbiAgICBpZiAoZm9ybWF0dGVkT3BlcmF0b3IgJiYgdmFsaWRPcGVyYXRvcnMuaW5jbHVkZXMoZm9ybWF0dGVkT3BlcmF0b3IgYXMgT3BlcmF0b3IpKSB7XG4gICAgICBjb25zdCBvcGVyYXRvcktleSA9IG9wZXJhdG9yTWFwW2Zvcm1hdHRlZE9wZXJhdG9yXVxuXG4gICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ3JlbGF0aW9uc2hpcCcgfHwgZmllbGQudHlwZSA9PT0gJ3VwbG9hZCcpIHtcbiAgICAgICAgbGV0IGhhc051bWJlcklEUmVsYXRpb25cbiAgICAgICAgbGV0IG11bHRpSURDb25kaXRpb24gPSAnJG9yJ1xuICAgICAgICBpZiAob3BlcmF0b3JLZXkgPT09ICckbmUnKSBtdWx0aUlEQ29uZGl0aW9uID0gJyRhbmQnXG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgIHZhbHVlOiB7XG4gICAgICAgICAgICBbbXVsdGlJRENvbmRpdGlvbl06IFt7IFtwYXRoXTogeyBbb3BlcmF0b3JLZXldOiBmb3JtYXR0ZWRWYWx1ZSB9IH1dLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGZvcm1hdHRlZFZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGlmIChtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKGZvcm1hdHRlZFZhbHVlKSkge1xuICAgICAgICAgICAgcmVzdWx0LnZhbHVlW211bHRpSURDb25kaXRpb25dLnB1c2goe1xuICAgICAgICAgICAgICBbcGF0aF06IHsgW29wZXJhdG9yS2V5XTogT2JqZWN0SWQoZm9ybWF0dGVkVmFsdWUpIH0sXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICA7KEFycmF5LmlzQXJyYXkoZmllbGQucmVsYXRpb25UbykgPyBmaWVsZC5yZWxhdGlvblRvIDogW2ZpZWxkLnJlbGF0aW9uVG9dKS5mb3JFYWNoKFxuICAgICAgICAgICAgICAocmVsYXRpb25UbykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzUmVsYXRlZFRvQ3VzdG9tTnVtYmVySUQgPSBwYXlsb2FkLmNvbGxlY3Rpb25zW1xuICAgICAgICAgICAgICAgICAgcmVsYXRpb25Ub1xuICAgICAgICAgICAgICAgIF0/LmNvbmZpZz8uZmllbGRzLmZpbmQoKHJlbGF0ZWRGaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgZmllbGRBZmZlY3RzRGF0YShyZWxhdGVkRmllbGQpICYmXG4gICAgICAgICAgICAgICAgICAgIHJlbGF0ZWRGaWVsZC5uYW1lID09PSAnaWQnICYmXG4gICAgICAgICAgICAgICAgICAgIHJlbGF0ZWRGaWVsZC50eXBlID09PSAnbnVtYmVyJ1xuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICBpZiAoaXNSZWxhdGVkVG9DdXN0b21OdW1iZXJJRCkge1xuICAgICAgICAgICAgICAgICAgaWYgKGlzUmVsYXRlZFRvQ3VzdG9tTnVtYmVySUQudHlwZSA9PT0gJ251bWJlcicpIGhhc051bWJlcklEUmVsYXRpb24gPSB0cnVlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICBpZiAoaGFzTnVtYmVySURSZWxhdGlvbilcbiAgICAgICAgICAgICAgcmVzdWx0LnZhbHVlW211bHRpSURDb25kaXRpb25dLnB1c2goe1xuICAgICAgICAgICAgICAgIFtwYXRoXTogeyBbb3BlcmF0b3JLZXldOiBwYXJzZUZsb2F0KGZvcm1hdHRlZFZhbHVlKSB9LFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQudmFsdWVbbXVsdGlJRENvbmRpdGlvbl0ubGVuZ3RoID4gMSkge1xuICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZm9ybWF0dGVkT3BlcmF0b3IgPT09ICdsaWtlJyAmJiB0eXBlb2YgZm9ybWF0dGVkVmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbnN0IHdvcmRzID0gZm9ybWF0dGVkVmFsdWUuc3BsaXQoJyAnKVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgICB2YWx1ZToge1xuICAgICAgICAgICAgJGFuZDogd29yZHMubWFwKCh3b3JkKSA9PiAoe1xuICAgICAgICAgICAgICBbcGF0aF06IHtcbiAgICAgICAgICAgICAgICAkb3B0aW9uczogJ2knLFxuICAgICAgICAgICAgICAgICRyZWdleDogd29yZC5yZXBsYWNlKC9bXFxcXF4kKis/LigpfFtcXF17fV0vZywgJ1xcXFwkJicpLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICB9XG5cbiAgICAgIC8vIFNvbWUgb3BlcmF0b3JzIGxpa2UgJ25lYXInIG5lZWQgdG8gZGVmaW5lIGEgZnVsbCBxdWVyeVxuICAgICAgLy8gc28gaWYgdGhlcmUgaXMgbm8gb3BlcmF0b3Iga2V5LCBqdXN0IHJldHVybiB0aGUgdmFsdWVcbiAgICAgIGlmICghb3BlcmF0b3JLZXkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBwYXRoLFxuICAgICAgICAgIHZhbHVlOiBmb3JtYXR0ZWRWYWx1ZSxcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRoLFxuICAgICAgICB2YWx1ZTogeyBbb3BlcmF0b3JLZXldOiBmb3JtYXR0ZWRWYWx1ZSB9LFxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG4iXSwibmFtZXMiOlsiYnVpbGRTZWFyY2hQYXJhbSIsIk9iamVjdElkIiwiT2JqZWN0SWRJbXBvcnQiLCJzdWJRdWVyeU9wdGlvbnMiLCJsZWFuIiwibGltaXQiLCJjb2xsZWN0aW9uU2x1ZyIsImZpZWxkcyIsImdsb2JhbFNsdWciLCJpbmNvbWluZ1BhdGgiLCJsb2NhbGUiLCJvcGVyYXRvciIsInBheWxvYWQiLCJ2YWwiLCJzYW5pdGl6ZWRQYXRoIiwicmVwbGFjZSIsInBhdGhzIiwiaGFzQ3VzdG9tSUQiLCJjdXN0b21JRGZpZWxkIiwiY29sbGVjdGlvbnMiLCJjb25maWciLCJmaW5kIiwiZmllbGQiLCJmaWVsZEFmZmVjdHNEYXRhIiwibmFtZSIsImlkRmllbGRUeXBlIiwidHlwZSIsInB1c2giLCJjb21wbGV0ZSIsInBhdGgiLCJnZXRMb2NhbGl6ZWRQYXRocyIsImZvcm1hdHRlZE9wZXJhdG9yIiwicmF3UXVlcnkiLCJmb3JtYXR0ZWRWYWx1ZSIsInNhbml0aXplUXVlcnlWYWx1ZSIsInZhbHVlIiwibGVuZ3RoIiwicGF0aHNUb1F1ZXJ5Iiwic2xpY2UiLCJyZXZlcnNlIiwiaW5pdGlhbFJlbGF0aW9uc2hpcFF1ZXJ5IiwicmVsYXRpb25zaGlwUXVlcnkiLCJyZWR1Y2UiLCJwcmlvclF1ZXJ5Iiwic2x1ZyIsInN1YlBhdGgiLCJpIiwicHJpb3JRdWVyeVJlc3VsdCIsIlN1Yk1vZGVsIiwiZGIiLCJzdWJRdWVyeSIsImJ1aWxkUXVlcnkiLCJ3aGVyZSIsInJlc3VsdCIsIiRpbiIsImZvckVhY2giLCJkb2MiLCJzdHJpbmdJRCIsIl9pZCIsInRvU3RyaW5nIiwibW9uZ29vc2UiLCJUeXBlcyIsImlzVmFsaWQiLCJuZXh0U3ViUGF0aCIsIm1hcCIsIlByb21pc2UiLCJyZXNvbHZlIiwidmFsaWRPcGVyYXRvcnMiLCJpbmNsdWRlcyIsIm9wZXJhdG9yS2V5Iiwib3BlcmF0b3JNYXAiLCJoYXNOdW1iZXJJRFJlbGF0aW9uIiwibXVsdGlJRENvbmRpdGlvbiIsIkFycmF5IiwiaXNBcnJheSIsInJlbGF0aW9uVG8iLCJpc1JlbGF0ZWRUb0N1c3RvbU51bWJlcklEIiwicmVsYXRlZEZpZWxkIiwicGFyc2VGbG9hdCIsIndvcmRzIiwic3BsaXQiLCIkYW5kIiwid29yZCIsIiRvcHRpb25zIiwiJHJlZ2V4IiwidW5kZWZpbmVkIl0sInJhbmdlTWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzsiLCJtYXBwaW5ncyI6Ijs7OzsrQkFnQ3NCQTs7O2VBQUFBOzs7cUVBM0JLO2lFQUNOOzBCQUNhO3VCQUNEOzZCQUtMO29DQUNPOzs7Ozs7QUFFbkMsTUFBTUMsV0FB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